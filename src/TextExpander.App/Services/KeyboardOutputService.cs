[{"text": "using System.Runtime.InteropServices;\nusing TextExpander.Core.Models;\n\nnamespace TextExpander.App.Services;\n\n/// <summary>\n/// \ud0a4\ubcf4\ub4dc \ucd9c\ub825 \uc11c\ube44\uc2a4\n/// Win32 SendInput API\ub97c \uc0ac\uc6a9\ud558\uc5ec \ud0a4 \uc785\ub825 \uc2dc\ubbac\ub808\uc774\uc158\n/// </summary>\npublic class KeyboardOutputService : IDisposable\n{\n    #region Win32 API \uc120\uc5b8\n\n    [DllImport(\"user32.dll\", SetLastError = true)]\n    private static extern uint SendInput(uint nInputs, INPUT[] pInputs, int cbSize);\n\n    [DllImport(\"user32.dll\")]\n    private static extern short VkKeyScan(char ch);\n\n    [StructLayout(LayoutKind.Sequential)]\n    private struct INPUT\n    {\n        public uint type;\n        public INPUTUNION union;\n    }\n\n    [StructLayout(LayoutKind.Explicit)]\n    private struct INPUTUNION\n    {\n        [FieldOffset(0)] public MOUSEINPUT mi;\n        [FieldOffset(0)] public KEYBDINPUT ki;\n        [FieldOffset(0)] public HARDWAREINPUT hi;\n    }\n\n    [StructLayout(LayoutKind.Sequential)]\n    private struct MOUSEINPUT\n    {\n        public int dx;\n        public int dy;\n        public uint mouseData;\n        public uint dwFlags;\n        public uint time;\n        public IntPtr dwExtraInfo;\n    }\n\n    [StructLayout(LayoutKind.Sequential)]\n    private struct KEYBDINPUT\n    {\n        public ushort wVk;\n        public ushort wScan;\n        public uint dwFlags;\n        public uint time;\n        public IntPtr dwExtraInfo;\n    }\n\n    [StructLayout(LayoutKind.Sequential)]\n    private struct HARDWAREINPUT\n    {\n        public uint uMsg;\n        public ushort wParamL;\n        public ushort wParamH;\n    }\n\n    private const uint INPUT_KEYBOARD = 1;\n    private const uint KEYEVENTF_KEYUP = 0x0002;\n    private const uint KEYEVENTF_UNICODE = 0x0004;\n\n    private const ushort VK_BACK = 0x08;\n    private const ushort VK_RETURN = 0x0D;\n    private const ushort VK_TAB = 0x09;\n    private const ushort VK_SPACE = 0x20;\n\n    // \uc6b0\ub9ac\uac00 \ubcf4\ub0b8 \uc785\ub825\uc784\uc744 \uc2dd\ubcc4\ud558\uae30 \uc704\ud55c \ub9c8\ucee4\n    // \"TEXT\" (0x54=T, 0x45=E, 0x58=X, 0x54=T in ASCII hex)\n    private static readonly IntPtr SENT_BY_US_MARKER = new IntPtr(0x54455854);\n\n    #endregion\n\n    private volatile bool _isSending = false;\n    private readonly object _sendLock = new();\n    private AppSettings _settings = new();\n\n    /// <summary>\n    /// \ud604\uc7ac \ud0a4 \uc1a1\uc2e0 \uc911\uc778\uc9c0 \uc5ec\ubd80 (\uc2a4\ub808\ub4dc \uc548\uc804)\n    /// </summary>\n    public bool IsSending => _isSending;\n\n    /// <summary>\n    /// \uc1a1\uc2e0 \ud50c\ub798\uadf8 \uc124\uc815 (\uc2a4\ub808\ub4dc \uc548\uc804)\n    /// </summary>\n    public void SetSendingFlag(bool sending)\n    {\n        _isSending = sending;\n    }\n\n    /// <summary>\n    /// \uc124\uc815 \uc5c5\ub370\uc774\ud2b8\n    /// </summary>\n    public void SetSettings(AppSettings settings)\n    {\n        _settings = settings ?? throw new ArgumentNullException(nameof(settings));\n    }\n\n    /// <summary>\n    /// Backspace \ud0a4\ub97c \uc9c0\uc815\ub41c \ud69f\uc218\ub9cc\ud07c \uc804\uc1a1\n    /// </summary>\n    public void SendBackspaces(int count)\n    {\n        if (count <= 0) return;\n\n        lock (_sendLock)\n        {\n            // \uba54\ubaa8\uc7a5 \ub4f1 \ub290\ub9b0 \uc560\ud50c\ub9ac\ucf00\uc774\uc158 \ud638\ud658\uc131\uc744 \uc704\ud574 \ud55c \ubc88\uc5d0 \ud558\ub098\uc529 \uc804\uc1a1\n            for (int i = 0; i < count; i++)\n            {\n                var inputs = new INPUT[]\n                {\n                    CreateKeyInput(VK_BACK, false),\n                    CreateKeyInput(VK_BACK, true)\n                };\n                \n                SendInput((uint)inputs.Length, inputs, Marshal.SizeOf<INPUT>());\n                \n                // \uac01 \ud0a4 \uc0ac\uc774 \ub51c\ub808\uc774 (\uba54\ubaa8\uc7a5 \ud638\ud658\uc131)\n                Thread.Sleep(_settings.BackspaceDelayMs);\n            }\n        }\n    }\n\n    /// <summary>\n    /// \ud14d\uc2a4\ud2b8 \ubb38\uc790\uc5f4 \uc804\uc1a1 (Unicode \ubc29\uc2dd)\n    /// </summary>\n    public void SendText(string text)\n    {\n        if (string.IsNullOrEmpty(text)) return;\n\n        lock (_sendLock)\n        {\n            foreach (char ch in text)\n            {\n                INPUT[] inputs;\n                \n                // \uc904\ubc14\uafc8 \ucc98\ub9ac\n                if (ch == '\\n')\n                {\n                    inputs = new[]\n                    {\n                        CreateKeyInput(VK_RETURN, false),\n                        CreateKeyInput(VK_RETURN, true)\n                    };\n                }\n                else if (ch == '\\r')\n                {\n                    // CR\uc740 \ubb34\uc2dc (Windows\uc5d0\uc11c \uc904\ubc14\uafc8\uc740 \ubcf4\ud1b5 CRLF\uc9c0\ub9cc Enter \ud55c \ubc88\uc73c\ub85c \ucc98\ub9ac)\n                    continue;\n                }\n                else if (ch == '\\t')\n                {\n                    inputs = new[]\n                    {\n                        CreateKeyInput(VK_TAB, false),\n                        CreateKeyInput(VK_TAB, true)\n                    };\n                }\n                else\n                {\n                    // Unicode \ubb38\uc790\ub85c \uc804\uc1a1\n                    inputs = new[]\n                    {\n                        CreateUnicodeInput(ch, false),\n                        CreateUnicodeInput(ch, true)\n                    };\n                }\n\n                SendInput((uint)inputs.Length, inputs, Marshal.SizeOf<INPUT>());\n                \n                // \uac01 \ubb38\uc790 \uc0ac\uc774 \ub51c\ub808\uc774 (\uba54\ubaa8\uc7a5 \ud638\ud658\uc131)\n                Thread.Sleep(_settings.TextCharDelayMs);\n            }\n        }\n    }\n\n    /// <summary>\n    /// \ub2e8\uc77c \ubb38\uc790 \uc804\uc1a1\n    /// </summary>\n    public void SendChar(char ch)\n    {\n        lock (_sendLock)\n        {\n            INPUT[] inputs;\n\n            switch (ch)\n            {\n                case '\\n':\n                    inputs = new[]\n                    {\n                        CreateKeyInput(VK_RETURN, false),\n                        CreateKeyInput(VK_RETURN, true)\n                    };\n                    break;\n                case '\\r':\n                    // CR\uc740 \ubb34\uc2dc\n                    return;\n                case '\\t':\n                    inputs = new[]\n                    {\n                        CreateKeyInput(VK_TAB, false),\n                        CreateKeyInput(VK_TAB, true)\n                    };\n                    break;\n                case ' ':\n                    inputs = new[]\n                    {\n                        CreateKeyInput(VK_SPACE, false),\n                        CreateKeyInput(VK_SPACE, true)\n                    };\n                    break;\n                default:\n                    inputs = new[]\n                    {\n                        CreateUnicodeInput(ch, false),\n                        CreateUnicodeInput(ch, true)\n                    };\n                    break;\n            }\n\n            SendInput((uint)inputs.Length, inputs, Marshal.SizeOf<INPUT>());\n            \n            // \uba54\ubaa8\uc7a5 \ud638\ud658\uc131\uc744 \uc704\ud55c \ub51c\ub808\uc774 \ucd94\uac00\n            Thread.Sleep(_settings.TextCharDelayMs);\n        }\n    }\n\n    /// <summary>\n    /// \uac00\uc0c1 \ud0a4 \ucf54\ub4dc \uae30\ubc18 \ud0a4 \uc785\ub825 \uc0dd\uc131\n    /// </summary>\n    private static INPUT CreateKeyInput(ushort vkCode, bool keyUp)\n    {\n        return new INPUT\n        {\n            type = INPUT_KEYBOARD,\n            union = new INPUTUNION\n            {\n                ki = new KEYBDINPUT\n                {\n                    wVk = vkCode,\n                    wScan = 0,\n                    dwFlags = keyUp ? KEYEVENTF_KEYUP : 0,\n                    time = 0,\n                    dwExtraInfo = SENT_BY_US_MARKER\n                }\n            }\n        };\n    }\n\n    /// <summary>\n    /// Unicode \ubb38\uc790 \uae30\ubc18 \ud0a4 \uc785\ub825 \uc0dd\uc131\n    /// </summary>\n    private static INPUT CreateUnicodeInput(char ch, bool keyUp)\n    {\n        return new INPUT\n        {\n            type = INPUT_KEYBOARD,\n            union = new INPUTUNION\n            {\n                ki = new KEYBDINPUT\n                {\n                    wVk = 0,\n                    wScan = ch,\n                    dwFlags = KEYEVENTF_UNICODE | (keyUp ? KEYEVENTF_KEYUP : 0),\n                    time = 0,\n                    dwExtraInfo = SENT_BY_US_MARKER\n                }\n            }\n        };\n    }\n\n    /// <summary>\n    /// \ub9ac\uc18c\uc2a4 \uc815\ub9ac\n    /// </summary>\n    public void Dispose()\n    {\n        // \ud604\uc7ac\ub294 \uad00\ub9ac\ub418\uc9c0 \uc54a\ub294 \ub9ac\uc18c\uc2a4\uac00 \uc5c6\uc9c0\ub9cc,\n        // \ud5a5\ud6c4 SemaphoreSlim \ub4f1 IDisposable \ub9ac\uc18c\uc2a4 \ucd94\uac00 \uc2dc \uc5ec\uae30\uc11c \uc815\ub9ac\n        GC.SuppressFinalize(this);\n    }\n}\n", "type": "text"}]